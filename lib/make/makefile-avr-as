file = $(lastword $(MAKECMDGOALS))
NAME = $(basename $(file))
DIR = tmp/$(NAME)

# Variables
MCU = atmega328p
MCU_PROG = m328p
LIB_DIR = ${HOME}/atmega/lib/gcc-avr
AVRDUDE_PROGRAMMER = arduino
AVRDUDE_PORT = /dev/ttyUSB0
AVRDUDE_BAUDRATE = 115200

all: $(DIR)/$(NAME).hex
	@echo "OK"

$(DIR)/$(NAME).elf: $(file)
	@mkdir -p $(DIR)
	avr-as -mmcu=$(MCU) -I $(LIB_DIR) -o $(DIR)/$(NAME).o $(file)
	avr-ld -e RESET -nostartfiles -o $(DIR)/$(NAME).elf $(DIR)/$(NAME).o

$(DIR)/$(NAME).hex: $(DIR)/$(NAME).elf
	avr-objcopy -O ihex $(DIR)/$(NAME).elf $(DIR)/$(NAME).hex

upload: $(DIR)/$(NAME).hex
	"avrdude" -c $(AVRDUDE_PROGRAMMER) -b $(AVRDUDE_BAUDRATE) -p $(MCU_PROG) -P $(AVRDUDE_PORT) -U flash:w:$(DIR)/$(NAME).hex:i

clean:
	rm -rf tmp

*.asm: all

